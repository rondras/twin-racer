<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0NNFMP26"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8X0NNFMP26');
    </script>
     
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin Racer Booster</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.6/dist/tonconnect-ui.min.js"></script>
    <script src="tg.js" defer></script>
    <script src="api.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.41/dist/tonweb.js"></script>
    <link rel="stylesheet" href="./styles/leaderboard.css">
    <link rel="stylesheet" href="./styles/booster.css">
    
</head>
<body>
    <header>
        <div class="header-container">
            <img src="images/back_button.png"home-button" onclick="window.location.href='index.html'">
            <h1 class="game-title">Twin Racer</h1>
            <p class="tagline">Shop</p>
        </div>
    </header>
    
    <main class="main-content">
        <video autoplay loop muted playsinline>
            <source src="./images/Auto-Farmer4.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="purchase-info" id="purchaseInfo">
            <div>Speed Booster Level <span id="boosterLevelNew"></span></div>
            <div> It will increase your max speed by 5%.</div>
            <div> Price: <span id="boosterPrice"></span>&nbsp;TON</div>
        </div>
        <div class="quest-item">
            <div id="ton-connect"></div>
        </div>
        <button class="purchase-button" id="purchaseButtonBooster" onclick="purchaseBooster()">Purchase Booster</button>
        
    </main>

    <footer>
        <div class="footer-container">
            <p>Follow Us</p>
            <div class="social-icons">
                <a href="https://www.tiktok.com/@twin_racer" target="_blank"><img src="images/Icon_TikTok.png" alt="TikTok"></a>
                <a href="https://x.com/twin_race" target="_blank"><img src="images/Icon_X.png" alt="X (formerly Twitter)"></a>
                <a href="https://discord.gg/852Vr8S5Sf" target="_blank"><img src="images/Icon_Discord.png" alt="Discord"></a>
            </div>
        </div>
    </footer>

    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://racer.twinfinance.io/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });
        tonConnectUI.uiOptions = {
            twaReturnUrl: 'https://t.me/TwinRacer_bot/TwinRacer?startapp'
        };

        async function purchaseBooster(){
            userD = await userData(tgID)
            boosterLevel = userD.boosterLevel
            console.log(boosterLevel)
            r = await sendTonTransaction(getBoosterPrice(boosterLevel+1)*1000000000)
            console.log(r)
            if (r.success) {
                trxID = r.trxID
                data = await doBuyBooster(tgID,boosterLevel+1,trxID) 
                console.log(data)
                if (data.message.startsWith('Booster purchase done:')){
                    loadBoosterData()
                }
            }
            
            //trxID = "1234"
            
        }

        function getBoosterPrice(boosterLevel){
            if (boosterLevel === 1){return(0.001)}
            if (boosterLevel === 2){return(0.002)}
            if (boosterLevel === 3){return(0.5)}
            if (boosterLevel === 4){return(1)}
            if (boosterLevel === 5){return(2)}
            if (boosterLevel === 6){return(5)}
            if (boosterLevel === 7){return(10)}

        }

        async function loadBoosterData(){
            
            console.log('LoadingBoosterData');
            
            try {
                // Assume you have a function that retrieves user data, like userData(tgID)
                const userD = await userData(tgID);  // Fetch user data
                const boosterLevel = userD.boosterLevel;  // Extract booster level
                console.log('Booster Level:', boosterLevel);
                const boosterPrice = getBoosterPrice(boosterLevel+1)
                
                // Update the span element with boosterLevel + 1
                document.getElementById("boosterLevelNew").textContent = boosterLevel + 1;
                document.getElementById("boosterPrice").textContent = boosterPrice
                return (boosterLevel)

            } catch (error) {
                console.error("Error loading booster data:", error);
            }
        }
        

        window.onload = () => {
            //tgID = 458176513
            const intervalId = setInterval(() => {
                if (tgID) {
                    userD = userData(tgID)
                    boosterLevel = loadBoosterData()
                    clearInterval(intervalId);
                } else {
                    console.log("Waiting for tgID to be initialized...");
                }
            }, 100); // Check every 100ms
        };
    </script>
</body>
</html>
